

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>การแบ่งรายรับเข้า Pocket</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f5f7ff;
        }
        
        .card {
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            transition: width 1s ease-in-out;
        }
        
        .header-gradient {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
        }
        
        .total-row {
            background: linear-gradient(90deg, #e0e7ff 0%, #c7d2fe 100%);
        }
        
        input[type="number"] {
            transition: all 0.3s ease;
        }
        
        input[type="number"]:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .highlight {
            animation: highlight 1s ease-in-out;
        }
        
        @keyframes highlight {
            0% { background-color: rgba(99, 102, 241, 0.2); }
            100% { background-color: transparent; }
        }
        
        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .timeline-line {
            width: 2px;
            background-color: #d1d5db;
        }
        
        .tab-active {
            background-color: #4f46e5;
            color: white;
        }
        
        .tab-inactive {
            background-color: #e0e7ff;
            color: #4f46e5;
        }
        
        .debug-info {
            font-family: monospace;
            font-size: 12px;
            padding: 8px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="min-h-screen py-8 px-4">
        <div class="max-w-5xl mx-auto">
            <div class="header-gradient rounded-xl p-6 mb-8 text-white">
                <h1 class="text-3xl font-bold text-center">การแบ่งรายรับเข้า Pocket ให้ตรงทุกเดือน</h1>
                <p class="text-center mt-2 text-indigo-100">วางแผนการเงินแยกตามช่วงเงินเดือน</p>
            </div>
            
            <!-- Input Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4 text-indigo-900">กรอกรายรับของคุณ</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="midMonthSalary" class="block text-sm font-medium text-gray-700 mb-1">เงินเดือนวันที่ 15</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500">฿</span>
                            </div>
                            <input type="number" id="midMonthSalary" class="block w-full pl-10 pr-12 py-3 border border-gray-300 rounded-lg focus:outline-none" placeholder="00.00" value="">
                            <div class="absolute inset-y-0 right-0 flex items-center">
                                <label for="midMonthSalary" class="sr-only">Currency</label>
                                <span class="text-gray-500 pr-3">THB</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label for="endMonthSalary" class="block text-sm font-medium text-gray-700 mb-1">เงินเดือนช่วงสิ้นเดือน (วันที่ 27-30)</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500">฿</span>
                            </div>
                            <input type="number" id="endMonthSalary" class="block w-full pl-10 pr-12 py-3 border border-gray-300 rounded-lg focus:outline-none" placeholder="00.00" value="">
                            <div class="absolute inset-y-0 right-0 flex items-center">
                                <label for="endMonthSalary" class="sr-only">Currency</label>
                                <span class="text-gray-500 pr-3">THB</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button id="calculateBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                        คำนวณการแบ่งรายรับ
                    </button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="flex mb-6">
                <button id="tabMonthly" class="flex-1 py-3 px-4 rounded-tl-lg rounded-bl-lg tab-active font-medium transition-colors">
                    ภาพรวมทั้งเดือน
                </button>
                <button id="tabMidMonth" class="flex-1 py-3 px-4 tab-inactive font-medium transition-colors">
                    เงินเดือนวันที่ 15
                </button>
                <button id="tabEndMonth" class="flex-1 py-3 px-4 rounded-tr-lg rounded-br-lg tab-inactive font-medium transition-colors">
                    เงินเดือนสิ้นเดือน
                </button>
            </div>
            
            <!-- Monthly Overview Section -->
            <div id="monthlySection" class="mb-8">
                <!-- Timeline -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-xl font-semibold mb-6 text-indigo-900">ไทม์ไลน์การเงินประจำเดือน</h2>
                    
                    <div class="relative">
                        <!-- Timeline line -->
                        <div class="absolute left-6 top-0 bottom-0 timeline-line"></div>
                        
                        <!-- Day 1-5 -->
                        <div class="flex mb-8 relative">
                            <div class="timeline-dot bg-red-500 z-10 mt-1.5 mr-4"></div>
                            <div class="bg-red-50 rounded-lg p-4 flex-1">
                                <h3 class="font-medium text-red-800">วันที่ 1-5</h3>
                                <p class="text-sm text-red-700 mt-1">จ่ายค่าห้อง <span class="font-semibold" id="rentAmount">฿0</span> (ใช้เงินจากสิ้นเดือนก่อนหน้า)</p>
                                <p class="text-sm text-red-700 mt-1">จ่ายบัตรเครดิตงวดแรก <span class="font-semibold" id="creditCard1Amount">฿0</span> (ใช้เงินจากสิ้นเดือนก่อนหน้า)</p>
                            </div>
                        </div>
                        
                        <!-- Day 15 -->
                        <div class="flex mb-8 relative">
                            <div class="timeline-dot bg-green-500 z-10 mt-1.5 mr-4"></div>
                            <div class="bg-green-50 rounded-lg p-4 flex-1">
                                <h3 class="font-medium text-green-800">วันที่ 15</h3>
                                <p class="text-sm text-green-700 mt-1">รับเงินเดือนก้อนแรก <span class="font-semibold" id="midMonthAmount">฿0</span></p>
                                <p class="text-sm text-green-700 mt-1">โอนให้ครอบครัว <span class="font-semibold" id="familyAmount">฿0</span></p>
                                <p class="text-sm text-green-700 mt-1">แบ่งค่ากินครึ่งเดือน <span class="font-semibold" id="foodMidAmount">฿0</span></p>
                                <p class="text-sm text-green-700 mt-1">เก็บเงินประกัน <span class="font-semibold" id="insuranceAmount">฿0</span></p>
                                <p class="text-sm text-green-700 mt-1">เงินฉุกเฉิน + เงินเก็บ <span class="font-semibold" id="savingsMidAmount">฿0</span></p>
                            </div>
                        </div>
                        
                        <!-- Day 20 -->
                        <div class="flex mb-8 relative">
                            <div class="timeline-dot bg-red-500 z-10 mt-1.5 mr-4"></div>
                            <div class="bg-red-50 rounded-lg p-4 flex-1">
                                <h3 class="font-medium text-red-800">วันที่ 20</h3>
                                <p class="text-sm text-red-700 mt-1">จ่ายบัตรเครดิตงวดสอง <span class="font-semibold" id="creditCard2Amount">฿0</span> (ใช้เงินจากวันที่ 15)</p>
                            </div>
                        </div>
                        
                        <!-- Day 27-30 -->
                        <div class="flex relative">
                            <div class="timeline-dot bg-green-500 z-10 mt-1.5 mr-4"></div>
                            <div class="bg-green-50 rounded-lg p-4 flex-1">
                                <h3 class="font-medium text-green-800">วันที่ 27-30</h3>
                                <p class="text-sm text-green-700 mt-1">รับเงินเดือนก้อนสอง <span class="font-semibold" id="endMonthAmount">฿0</span></p>
                                <p class="text-sm text-green-700 mt-1">แบ่งค่ากินครึ่งเดือน <span class="font-semibold" id="foodEndAmount">฿0</span></p>
                                <p class="text-sm text-green-700 mt-1">เตรียมเงินค่าห้องเดือนถัดไป <span class="font-semibold" id="nextRentAmount">฿0</span></p>
                                <p class="text-sm text-green-700 mt-1">เตรียมเงินบัตรเครดิตงวดแรกเดือนถัดไป <span class="font-semibold" id="nextCreditAmount">฿0</span></p>
                                <p class="text-sm text-green-700 mt-1">เงินฉุกเฉิน + เงินเก็บ <span class="font-semibold" id="savingsEndAmount">฿0</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Table -->
                <div class="overflow-x-auto bg-white rounded-xl shadow-lg mb-8">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-indigo-50">
                                <th class="py-4 px-6 text-left text-indigo-900 font-semibold">Pocket</th>
                                <th class="py-4 px-6 text-center text-indigo-900 font-semibold">เงินต่อเดือน (THB)</th>
                                <th class="py-4 px-6 text-center text-indigo-900 font-semibold">วันที่ 15</th>
                                <th class="py-4 px-6 text-center text-indigo-900 font-semibold">วันที่ 27-30</th>
                                <th class="py-4 px-6 text-center text-indigo-900 font-semibold">สัดส่วน</th>
                            </tr>
                        </thead>
                        <tbody id="mainTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Visualization -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Pie Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-lg card">
                        <h2 class="text-xl font-semibold mb-4 text-indigo-900">สัดส่วนการใช้จ่าย</h2>
                        <div class="aspect-square relative">
                            <svg viewBox="0 0 100 100" class="w-full h-full" id="pieChart">
                                <!-- Will be populated by JavaScript -->
                                <text x="50" y="50" text-anchor="middle" dy="0.3em" class="text-xl font-bold" id="totalAmount">0</text>
                                <text x="50" y="60" text-anchor="middle" dy="0.3em" class="text-xs">บาท/เดือน</text>
                            </svg>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mt-4" id="pieChartLegend">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Summary -->
                    <div class="bg-white p-6 rounded-xl shadow-lg card">
                        <h2 class="text-xl font-semibold mb-4 text-indigo-900">สรุปการแบ่งรายรับ</h2>
                        
                        <div class="space-y-4" id="summarySection">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        
                        <div class="mt-6 p-4 bg-indigo-50 rounded-lg">
                            <h3 class="font-medium text-indigo-900 mb-2">คำแนะนำ</h3>
                            <ul class="text-sm space-y-2 text-indigo-800" id="recommendationsList">
                                <!-- Will be populated by JavaScript -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mid-Month Section -->
            <div id="midMonthSection" class="mb-8 hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-indigo-900">การจัดสรรเงินเดือนวันที่ 15</h2>
                        <span class="text-lg font-bold text-indigo-600" id="midMonthTotalDisplay">฿0</span>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Allocation Cards -->
                        <div id="midMonthAllocationCards" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        
                        <!-- Action Plan -->
                        <div class="mt-8">
                            <h3 class="font-medium text-indigo-900 mb-4">แผนการจัดสรรเงิน</h3>
                            <ol class="space-y-4" id="midMonthActionPlan">
                                <!-- Will be populated by JavaScript -->
                            </ol>
                        </div>
                    </div>
                </div>
                
                <!-- Mid-Month Pie Chart -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-900">สัดส่วนการใช้จ่ายวันที่ 15</h2>
                    <div class="aspect-square relative max-w-md mx-auto">
                        <svg viewBox="0 0 100 100" class="w-full h-full" id="midMonthPieChart">
                            <!-- Will be populated by JavaScript -->
                            <text x="50" y="50" text-anchor="middle" dy="0.3em" class="text-xl font-bold" id="midMonthPieTotal">0</text>
                            <text x="50" y="60" text-anchor="middle" dy="0.3em" class="text-xs">บาท</text>
                        </svg>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mt-4" id="midMonthPieLegend">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- End-Month Section -->
            <div id="endMonthSection" class="mb-8 hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-indigo-900">การจัดสรรเงินเดือนช่วงสิ้นเดือน</h2>
                        <span class="text-lg font-bold text-indigo-600" id="endMonthTotalDisplay">฿0</span>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Allocation Cards -->
                        <div id="endMonthAllocationCards" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        
                        <!-- Action Plan -->
                        <div class="mt-8">
                            <h3 class="font-medium text-indigo-900 mb-4">แผนการจัดสรรเงิน</h3>
                            <ol class="space-y-4" id="endMonthActionPlan">
                                <!-- Will be populated by JavaScript -->
                            </ol>
                        </div>
                    </div>
                </div>
                
                <!-- End-Month Pie Chart -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-900">สัดส่วนการใช้จ่ายช่วงสิ้นเดือน</h2>
                    <div class="aspect-square relative max-w-md mx-auto">
                        <svg viewBox="0 0 100 100" class="w-full h-full" id="endMonthPieChart">
                            <!-- Will be populated by JavaScript -->
                            <text x="50" y="50" text-anchor="middle" dy="0.3em" class="text-xl font-bold" id="endMonthPieTotal">18,750</text>
                            <text x="50" y="60" text-anchor="middle" dy="0.3em" class="text-xs">บาท</text>
                        </svg>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mt-4" id="endMonthPieLegend">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Debug Section (hidden by default) -->
            <div id="debugSection" class="mb-8 hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-900">Debug Information</h2>
                    <div id="debugInfo" class="debug-info"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Define the budget categories and their default allocations
        const budgetCategories = [
            { 
                id: 'food', 
                name: 'ค่ากิน', 
                icon: '🍲', 
                amount: 5000, 
                details: 'จ่ายทุกวัน', 
                comment: 'แบ่งสองงวด งวดละ 2,500 บาท (ต้นเดือน + กลางเดือน)',
                color: '#10B981',
                midMonthAmount: 2500,
                endMonthAmount: 2500,
                priority: 1
            },
            { 
                id: 'rent', 
                name: 'ค่าห้อง', 
                icon: '🏠', 
                amount: 7600, 
                details: 'จ่ายทุกวันที่ 5', 
                comment: 'โอนเก็บไว้จากรายรับวันที่ 27–30 เพื่อเตรียมจ่ายทันเวลา',
                color: '#3B82F6',
                midMonthAmount: 0,
                endMonthAmount: 7600,
                priority: 1
            },
            { 
                id: 'family', 
                name: 'ครอบครัว', 
                icon: '👨‍👩‍👧', 
                amount: 5000, 
                details: 'โอนวันที่ 15', 
                comment: 'โอนทันทีเมื่อมีรายรับวันที่ 15',
                color: '#8B5CF6',
                midMonthAmount: 5000,
                endMonthAmount: 0,
                priority: 1
            },
            { 
                id: 'insurance', 
                name: 'ประกัน (เป้า 15,000/ปี)', 
                icon: '🛡️', 
                amount: 1250, 
                details: 'เก็บสะสมรายเดือน', 
                comment: 'เปิดบัญชีแยกเพื่อสะสมโดยเฉพาะ ควรใช้บัญชีไม่มีบัตร ATM',
                color: '#F59E0B',
                midMonthAmount: 1250,
                endMonthAmount: 0,
                priority: 2
            },
            { 
                id: 'creditCard', 
                name: 'บัตรเครดิต', 
                icon: '💳', 
                amount: 10000, 
                details: 'จ่ายทุกวันที่ 5 และ 20', 
                comment: 'แบ่งจ่ายงวดละ 5,000 บาท ใช้เงินจากช่วง 27–30 และวันที่ 15',
                color: '#EF4444',
                midMonthAmount: 5000,
                endMonthAmount: 5000,
                priority: 1
            },
            { 
                id: 'emergency', 
                name: 'เงินฉุกเฉิน', 
                icon: '🚨', 
                amount: 0, 
                details: 'สำรองหรือเผื่อใช้', 
                comment: 'ควรเก็บในบัญชีที่เข้าถึงยาก เช่นบัญชีออมทรัพย์แยก',
                color: '#F97316',
                midMonthAmount: 1500,
                endMonthAmount: 1500,
                priority: 3
            },
            { 
                id: 'savings', 
                name: 'เงินเก็บ', 
                icon: '💰', 
                amount: 0, 
                details: 'เก็บระยะยาว', 
                comment: 'ตั้งเป้าออมต่อเนื่อง ควรกระจายลงทุนบางส่วนถ้าเป็นไปได้',
                color: '#6366F1',
                midMonthAmount: 0,
                endMonthAmount: 0,
                priority: 4
            }
        ];
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Initial calculation
            calculateAllocations(
                parseFloat(document.getElementById('midMonthSalary').value) || 0,
                parseFloat(document.getElementById('endMonthSalary').value) || 0
            );
            
            // Initial render
            renderAllData();
            
            // Add event listener for the calculate button
            document.getElementById('calculateBtn').addEventListener('click', function() {
                calculateAndRender();
            });
            
            // Add event listeners for input changes
            document.getElementById('midMonthSalary').addEventListener('input', function() {
                document.getElementById('midMonthTotalDisplay').textContent = '฿' + formatNumber(this.value);
                document.getElementById('midMonthAmount').textContent = '฿' + formatNumber(this.value);
                document.getElementById('midMonthPieTotal').textContent = formatNumber(this.value);
            });
            
            document.getElementById('endMonthSalary').addEventListener('input', function() {
                document.getElementById('endMonthTotalDisplay').textContent = '฿' + formatNumber(this.value);
                document.getElementById('endMonthAmount').textContent = '฿' + formatNumber(this.value);
                document.getElementById('endMonthPieTotal').textContent = formatNumber(this.value);
            });
            
            // Add event listeners for tabs
            document.getElementById('tabMonthly').addEventListener('click', function() {
                showTab('monthly');
            });
            
            document.getElementById('tabMidMonth').addEventListener('click', function() {
                showTab('midMonth');
            });
            
            document.getElementById('tabEndMonth').addEventListener('click', function() {
                showTab('endMonth');
            });
            
            // Debug shortcut (Ctrl+Shift+D)
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                    const debugSection = document.getElementById('debugSection');
                    debugSection.classList.toggle('hidden');
                    if (!debugSection.classList.contains('hidden')) {
                        updateDebugInfo();
                    }
                }
            });
        });
        
        function showTab(tabName) {
            // Hide all sections
            document.getElementById('monthlySection').classList.add('hidden');
            document.getElementById('midMonthSection').classList.add('hidden');
            document.getElementById('endMonthSection').classList.add('hidden');
            
            // Reset all tab styles
            document.getElementById('tabMonthly').classList.remove('tab-active', 'tab-inactive');
            document.getElementById('tabMidMonth').classList.remove('tab-active', 'tab-inactive');
            document.getElementById('tabEndMonth').classList.remove('tab-active', 'tab-inactive');
            
            document.getElementById('tabMonthly').classList.add('tab-inactive');
            document.getElementById('tabMidMonth').classList.add('tab-inactive');
            document.getElementById('tabEndMonth').classList.add('tab-inactive');
            
            // Show the selected section and highlight the tab
            if (tabName === 'monthly') {
                document.getElementById('monthlySection').classList.remove('hidden');
                document.getElementById('tabMonthly').classList.remove('tab-inactive');
                document.getElementById('tabMonthly').classList.add('tab-active');
            } else if (tabName === 'midMonth') {
                document.getElementById('midMonthSection').classList.remove('hidden');
                document.getElementById('tabMidMonth').classList.remove('tab-inactive');
                document.getElementById('tabMidMonth').classList.add('tab-active');
            } else if (tabName === 'endMonth') {
                document.getElementById('endMonthSection').classList.remove('hidden');
                document.getElementById('tabEndMonth').classList.remove('tab-inactive');
                document.getElementById('tabEndMonth').classList.add('tab-active');
            }
        }
        
        function calculateAndRender() {
            // Get the input values
            const midMonthSalary = parseFloat(document.getElementById('midMonthSalary').value) || 0;
            const endMonthSalary = parseFloat(document.getElementById('endMonthSalary').value) || 0;
            
            // Update the total displayed
            document.getElementById('midMonthTotalDisplay').textContent = '฿' + formatNumber(midMonthSalary);
            document.getElementById('endMonthTotalDisplay').textContent = '฿' + formatNumber(endMonthSalary);
            document.getElementById('midMonthAmount').textContent = '฿' + formatNumber(midMonthSalary);
            document.getElementById('endMonthAmount').textContent = '฿' + formatNumber(endMonthSalary);
            document.getElementById('midMonthPieTotal').textContent = formatNumber(midMonthSalary);
            document.getElementById('endMonthPieTotal').textContent = formatNumber(endMonthSalary);
            
            // Calculate the allocations based on the new salary values
            calculateAllocations(midMonthSalary, endMonthSalary);
            
            // Render all data with the new calculations
            renderAllData();
            
            // Add highlight effect to show changes
            document.querySelectorAll('.allocation-item').forEach(item => {
                item.classList.add('highlight');
                setTimeout(() => {
                    item.classList.remove('highlight');
                }, 1000);
            });
            
            // Update debug info if visible
            if (!document.getElementById('debugSection').classList.contains('hidden')) {
                updateDebugInfo();
            }
        }
        
        function calculateAllocations(midMonthSalary, endMonthSalary) {
            // Reset all adjusted amounts
            budgetCategories.forEach(cat => {
                cat.adjustedMidAmount = 0;
                cat.adjustedEndAmount = 0;
            });
            
            // Calculate fixed expenses for each period (priority 1)
            let remainingMidMonth = midMonthSalary;
            let remainingEndMonth = endMonthSalary;
            
            // First, allocate to priority 1 (fixed expenses)
            budgetCategories
                .filter(cat => cat.priority === 1)
                .forEach(cat => {
                    // Mid-month allocation
                    if (cat.midMonthAmount > 0) {
                        if (remainingMidMonth >= cat.midMonthAmount) {
                            cat.adjustedMidAmount = cat.midMonthAmount;
                            remainingMidMonth -= cat.midMonthAmount;
                        } else {
                            cat.adjustedMidAmount = remainingMidMonth;
                            remainingMidMonth = 0;
                        }
                    }
                    
                    // End-month allocation
                    if (cat.endMonthAmount > 0) {
                        if (remainingEndMonth >= cat.endMonthAmount) {
                            cat.adjustedEndAmount = cat.endMonthAmount;
                            remainingEndMonth -= cat.endMonthAmount;
                        } else {
                            cat.adjustedEndAmount = remainingEndMonth;
                            remainingEndMonth = 0;
                        }
                    }
                });
            
            // Then allocate to priority 2 (insurance)
            budgetCategories
                .filter(cat => cat.priority === 2)
                .forEach(cat => {
                    // Mid-month allocation
                    if (cat.midMonthAmount > 0) {
                        if (remainingMidMonth >= cat.midMonthAmount) {
                            cat.adjustedMidAmount = cat.midMonthAmount;
                            remainingMidMonth -= cat.midMonthAmount;
                        } else {
                            cat.adjustedMidAmount = remainingMidMonth;
                            remainingMidMonth = 0;
                        }
                    }
                    
                    // End-month allocation
                    if (cat.endMonthAmount > 0) {
                        if (remainingEndMonth >= cat.endMonthAmount) {
                            cat.adjustedEndAmount = cat.endMonthAmount;
                            remainingEndMonth -= cat.endMonthAmount;
                        } else {
                            cat.adjustedEndAmount = remainingEndMonth;
                            remainingEndMonth = 0;
                        }
                    }
                });
            
            // Then allocate to priority 3 (emergency fund)
            budgetCategories
                .filter(cat => cat.priority === 3)
                .forEach(cat => {
                    // Mid-month allocation
                    if (cat.midMonthAmount > 0) {
                        if (remainingMidMonth >= cat.midMonthAmount) {
                            cat.adjustedMidAmount = cat.midMonthAmount;
                            remainingMidMonth -= cat.midMonthAmount;
                        } else {
                            cat.adjustedMidAmount = remainingMidMonth;
                            remainingMidMonth = 0;
                        }
                    }
                    
                    // End-month allocation
                    if (cat.endMonthAmount > 0) {
                        if (remainingEndMonth >= cat.endMonthAmount) {
                            cat.adjustedEndAmount = cat.endMonthAmount;
                            remainingEndMonth -= cat.endMonthAmount;
                        } else {
                            cat.adjustedEndAmount = remainingEndMonth;
                            remainingEndMonth = 0;
                        }
                    }
                });
            
            // Finally, allocate remaining to savings (priority 4)
            budgetCategories
                .filter(cat => cat.priority === 4)
                .forEach(cat => {
                    // Mid-month allocation
                    if (cat.midMonthAmount > 0 || remainingMidMonth > 0) {
                        // Add any remaining amount to the savings
                        cat.adjustedMidAmount = Math.max(0, cat.midMonthAmount);
                        
                        // If we have remaining funds, add them to savings
                        if (remainingMidMonth > 0) {
                            cat.adjustedMidAmount += remainingMidMonth;
                            remainingMidMonth = 0;
                        }
                    }
                    
                    // End-month allocation
                    if (cat.endMonthAmount > 0 || remainingEndMonth > 0) {
                        // Add any remaining amount to the savings
                        cat.adjustedEndAmount = Math.max(0, cat.endMonthAmount);
                        
                        // If we have remaining funds, add them to savings
                        if (remainingEndMonth > 0) {
                            cat.adjustedEndAmount += remainingEndMonth;
                            remainingEndMonth = 0;
                        }
                    }
                });
            
            // Calculate total adjusted amounts
            budgetCategories.forEach(cat => {
                cat.adjustedAmount = (cat.adjustedMidAmount || 0) + (cat.adjustedEndAmount || 0);
            });
            
            // Update timeline amounts
            const rentCat = budgetCategories.find(cat => cat.id === 'rent');
            const creditCardCat = budgetCategories.find(cat => cat.id === 'creditCard');
            const familyCat = budgetCategories.find(cat => cat.id === 'family');
            const foodCat = budgetCategories.find(cat => cat.id === 'food');
            const insuranceCat = budgetCategories.find(cat => cat.id === 'insurance');
            const emergencyCat = budgetCategories.find(cat => cat.id === 'emergency');
            const savingsCat = budgetCategories.find(cat => cat.id === 'savings');
            
            document.getElementById('rentAmount').textContent = '฿' + formatNumber(rentCat.adjustedEndAmount);
            document.getElementById('creditCard1Amount').textContent = '฿' + formatNumber(creditCardCat.adjustedEndAmount);
            document.getElementById('familyAmount').textContent = '฿' + formatNumber(familyCat.adjustedMidAmount);
            document.getElementById('foodMidAmount').textContent = '฿' + formatNumber(foodCat.adjustedMidAmount);
            document.getElementById('insuranceAmount').textContent = '฿' + formatNumber(insuranceCat.adjustedMidAmount);
            document.getElementById('creditCard2Amount').textContent = '฿' + formatNumber(creditCardCat.adjustedMidAmount);
            document.getElementById('foodEndAmount').textContent = '฿' + formatNumber(foodCat.adjustedEndAmount);
            document.getElementById('nextRentAmount').textContent = '฿' + formatNumber(rentCat.adjustedEndAmount);
            document.getElementById('nextCreditAmount').textContent = '฿' + formatNumber(creditCardCat.adjustedEndAmount);
            
            // Calculate combined savings for display
            const midMonthSavings = (emergencyCat.adjustedMidAmount || 0) + (savingsCat.adjustedMidAmount || 0);
            const endMonthSavings = (emergencyCat.adjustedEndAmount || 0) + (savingsCat.adjustedEndAmount || 0);
            
            document.getElementById('savingsMidAmount').textContent = '฿' + formatNumber(midMonthSavings);
            document.getElementById('savingsEndAmount').textContent = '฿' + formatNumber(endMonthSavings);
        }
        
        function renderAllData() {
            renderMainTable();
            renderPieChart();
            renderSummary();
            renderRecommendations();
            renderMidMonthAllocation();
            renderEndMonthAllocation();
            renderMidMonthPieChart();
            renderEndMonthPieChart();
        }
        
        function renderMainTable() {
            const tableBody = document.getElementById('mainTableBody');
            tableBody.innerHTML = '';
            
            let totalAmount = 0;
            let totalMidMonth = 0;
            let totalEndMonth = 0;
            
            budgetCategories.forEach(category => {
                const midAmount = category.adjustedMidAmount || 0;
                const endAmount = category.adjustedEndAmount || 0;
                const totalCatAmount = midAmount + endAmount;
                
                totalAmount += totalCatAmount;
                totalMidMonth += midAmount;
                totalEndMonth += endAmount;
                
                const row = document.createElement('tr');
                row.className = 'border-b border-indigo-100 hover:bg-indigo-50 transition-colors';
                
                row.innerHTML = `
                    <td class="py-4 px-6 font-medium">
                        <div class="flex items-center">
                            <span class="text-xl mr-2">${category.icon}</span>
                            <span>${category.name}</span>
                        </div>
                    </td>
                    <td class="py-4 px-6 text-center font-semibold">${formatNumber(totalCatAmount)}</td>
                    <td class="py-4 px-6 text-center">${formatNumber(midAmount)}</td>
                    <td class="py-4 px-6 text-center">${formatNumber(endAmount)}</td>
                    <td class="py-4 px-6">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full" style="background-color: ${category.color}; width: ${totalAmount > 0 ? (totalCatAmount / totalAmount * 100).toFixed(1) : 0}%"></div>
                        </div>
                        <div class="text-xs text-center mt-1">${totalAmount > 0 ? (totalCatAmount / totalAmount * 100).toFixed(1) : 0}%</div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row font-semibold';
            
            totalRow.innerHTML = `
                <td class="py-4 px-6">
                    <div class="flex items-center">
                        <span class="text-xl mr-2">📊</span>
                        <span>รวม</span>
                    </div>
                </td>
                <td class="py-4 px-6 text-center">${formatNumber(totalAmount)}</td>
                <td class="py-4 px-6 text-center">${formatNumber(totalMidMonth)}</td>
                <td class="py-4 px-6 text-center">${formatNumber(totalEndMonth)}</td>
                <td class="py-4 px-6">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-indigo-700 h-2 rounded-full" style="width: 100%"></div>
                    </div>
                    <div class="text-xs text-center mt-1">100%</div>
                </td>
            `;
            
            tableBody.appendChild(totalRow);
            
            // Update the total amount in the pie chart
            document.getElementById('totalAmount').textContent = formatNumber(totalAmount);
        }
        
        function renderPieChart() {
            const pieChart = document.getElementById('pieChart');
            const legend = document.getElementById('pieChartLegend');
            
            // Clear previous content except for the center text
            pieChart.innerHTML = `
                <text x="50" y="50" text-anchor="middle" dy="0.3em" class="text-xl font-bold" id="totalAmount">0</text>
                <text x="50" y="60" text-anchor="middle" dy="0.3em" class="text-xs">บาท/เดือน</text>
            `;
            
            legend.innerHTML = '';
            
            // Calculate total amount
            const totalAmount = budgetCategories.reduce((sum, category) => {
                return sum + (category.adjustedMidAmount || 0) + (category.adjustedEndAmount || 0);
            }, 0);
            
            // Update the total amount text
            document.getElementById('totalAmount').textContent = formatNumber(totalAmount);
            
            // Draw pie chart segments
            let cumulativeAngle = 0;
            
            // Only include categories with non-zero amounts
            const categoriesToShow = budgetCategories.filter(cat => 
                (cat.adjustedMidAmount || 0) + (cat.adjustedEndAmount || 0) > 0
            );
            
            categoriesToShow.forEach(category => {
                const midAmount = category.adjustedMidAmount || 0;
                const endAmount = category.adjustedEndAmount || 0;
                const amount = midAmount + endAmount;
                const percentage = totalAmount > 0 ? amount / totalAmount : 0;
                const angle = percentage * 360;
                
                // Calculate SVG arc parameters
                const radius = 45;
                const circumference = 2 * Math.PI * radius;
                const strokeDasharray = `${(angle / 360) * circumference} ${circumference}`;
                const strokeDashoffset = -cumulativeAngle / 360 * circumference;
                
                // Create circle segment
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", "50");
                circle.setAttribute("cy", "50");
                circle.setAttribute("r", radius.toString());
                circle.setAttribute("fill", "transparent");
                circle.setAttribute("stroke", category.color);
                circle.setAttribute("stroke-width", "10");
                circle.setAttribute("stroke-dasharray", strokeDasharray);
                circle.setAttribute("stroke-dashoffset", strokeDashoffset.toString());
                
                pieChart.insertBefore(circle, pieChart.firstChild);
                
                // Add to legend
                const legendItem = document.createElement('div');
                legendItem.className = 'flex items-center';
                legendItem.innerHTML = `
                    <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${category.color}"></span>
                    <span class="text-sm">${category.name} (${(percentage * 100).toFixed(1)}%)</span>
                `;
                
                legend.appendChild(legendItem);
                
                cumulativeAngle += angle;
            });
        }
        
        function renderMidMonthPieChart() {
            const pieChart = document.getElementById('midMonthPieChart');
            const legend = document.getElementById('midMonthPieLegend');
            
            // Clear previous content except for the center text
            pieChart.innerHTML = `
                <text x="50" y="50" text-anchor="middle" dy="0.3em" class="text-xl font-bold" id="midMonthPieTotal">0</text>
                <text x="50" y="60" text-anchor="middle" dy="0.3em" class="text-xs">บาท</text>
            `;
            
            legend.innerHTML = '';
            
            // Calculate total amount
            const midMonthSalary = parseFloat(document.getElementById('midMonthSalary').value) || 0;
            
            // Update the total amount text
            document.getElementById('midMonthPieTotal').textContent = formatNumber(midMonthSalary);
            
            // Draw pie chart segments
            let cumulativeAngle = 0;
            
            // Filter categories with mid-month allocation
            const midMonthCategories = budgetCategories.filter(cat => 
                (cat.adjustedMidAmount || 0) > 0
            );
            
            midMonthCategories.forEach(category => {
                const amount = category.adjustedMidAmount || 0;
                const percentage = midMonthSalary > 0 ? amount / midMonthSalary : 0;
                const angle = percentage * 360;
                
                // Calculate SVG arc parameters
                const radius = 45;
                const circumference = 2 * Math.PI * radius;
                const strokeDasharray = `${(angle / 360) * circumference} ${circumference}`;
                const strokeDashoffset = -cumulativeAngle / 360 * circumference;
                
                // Create circle segment
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", "50");
                circle.setAttribute("cy", "50");
                circle.setAttribute("r", radius.toString());
                circle.setAttribute("fill", "transparent");
                circle.setAttribute("stroke", category.color);
                circle.setAttribute("stroke-width", "10");
                circle.setAttribute("stroke-dasharray", strokeDasharray);
                circle.setAttribute("stroke-dashoffset", strokeDashoffset.toString());
                
                pieChart.insertBefore(circle, pieChart.firstChild);
                
                // Add to legend
                const legendItem = document.createElement('div');
                legendItem.className = 'flex items-center';
                legendItem.innerHTML = `
                    <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${category.color}"></span>
                    <span class="text-sm">${category.name} (${formatNumber(amount)} ฿)</span>
                `;
                
                legend.appendChild(legendItem);
                
                cumulativeAngle += angle;
            });
        }
        
        function renderEndMonthPieChart() {
            const pieChart = document.getElementById('endMonthPieChart');
            const legend = document.getElementById('endMonthPieLegend');
            
            // Clear previous content except for the center text
            pieChart.innerHTML = `
                <text x="50" y="50" text-anchor="middle" dy="0.3em" class="text-xl font-bold" id="endMonthPieTotal">0</text>
                <text x="50" y="60" text-anchor="middle" dy="0.3em" class="text-xs">บาท</text>
            `;
            
            legend.innerHTML = '';
            
            // Calculate total amount
            const endMonthSalary = parseFloat(document.getElementById('endMonthSalary').value) || 0;
            
            // Update the total amount text
            document.getElementById('endMonthPieTotal').textContent = formatNumber(endMonthSalary);
            
            // Draw pie chart segments
            let cumulativeAngle = 0;
            
            // Filter categories with end-month allocation
            const endMonthCategories = budgetCategories.filter(cat => 
                (cat.adjustedEndAmount || 0) > 0
            );
            
            endMonthCategories.forEach(category => {
                const amount = category.adjustedEndAmount || 0;
                const percentage = endMonthSalary > 0 ? amount / endMonthSalary : 0;
                const angle = percentage * 360;
                
                // Calculate SVG arc parameters
                const radius = 45;
                const circumference = 2 * Math.PI * radius;
                const strokeDasharray = `${(angle / 360) * circumference} ${circumference}`;
                const strokeDashoffset = -cumulativeAngle / 360 * circumference;
                
                // Create circle segment
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", "50");
                circle.setAttribute("cy", "50");
                circle.setAttribute("r", radius.toString());
                circle.setAttribute("fill", "transparent");
                circle.setAttribute("stroke", category.color);
                circle.setAttribute("stroke-width", "10");
                circle.setAttribute("stroke-dasharray", strokeDasharray);
                circle.setAttribute("stroke-dashoffset", strokeDashoffset.toString());
                
                pieChart.insertBefore(circle, pieChart.firstChild);
                
                // Add to legend
                const legendItem = document.createElement('div');
                legendItem.className = 'flex items-center';
                legendItem.innerHTML = `
                    <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${category.color}"></span>
                    <span class="text-sm">${category.name} (${formatNumber(amount)} ฿)</span>
                `;
                
                legend.appendChild(legendItem);
                
                cumulativeAngle += angle;
            });
        }
        
        function renderSummary() {
            const summarySection = document.getElementById('summarySection');
            summarySection.innerHTML = '';
            
            // Calculate category groups
            const totalAmount = budgetCategories.reduce((sum, category) => {
                return sum + (category.adjustedMidAmount || 0) + (category.adjustedEndAmount || 0);
            }, 0);
            
            const essentials = budgetCategories.filter(cat => ['food', 'rent'].includes(cat.id))
                .reduce((sum, cat) => {
                    return sum + (cat.adjustedMidAmount || 0) + (cat.adjustedEndAmount || 0);
                }, 0);
            
            const obligations = budgetCategories.filter(cat => ['creditCard', 'family'].includes(cat.id))
                .reduce((sum, cat) => {
                    return sum + (cat.adjustedMidAmount || 0) + (cat.adjustedEndAmount || 0);
                }, 0);
            
            const savings = budgetCategories.filter(cat => ['savings', 'insurance'].includes(cat.id))
                .reduce((sum, cat) => {
                    return sum + (cat.adjustedMidAmount || 0) + (cat.adjustedEndAmount || 0);
                }, 0);
            
            const emergency = budgetCategories.filter(cat => ['emergency'].includes(cat.id))
                .reduce((sum, cat) => {
                    return sum + (cat.adjustedMidAmount || 0) + (cat.adjustedEndAmount || 0);
                }, 0);
            
            // Create summary items
            createSummaryItem(
                summarySection, 
                'ค่าใช้จ่ายประจำ (ค่ากิน + ค่าห้อง)', 
                `${formatNumber(essentials)} บาท (${totalAmount > 0 ? (essentials / totalAmount * 100).toFixed(1) : 0}%)`,
                totalAmount > 0 ? (essentials / totalAmount * 100) : 0,
                '#3B82F6'
            );
            
            createSummaryItem(
                summarySection, 
                'ภาระผูกพัน (บัตรเครดิต + ครอบครัว)', 
                `${formatNumber(obligations)} บาท (${totalAmount > 0 ? (obligations / totalAmount * 100).toFixed(1) : 0}%)`,
                totalAmount > 0 ? (obligations / totalAmount * 100) : 0,
                '#8B5CF6'
            );
            
            createSummaryItem(
                summarySection, 
                'การออม (เงินเก็บ + ประกัน)', 
                `${formatNumber(savings)} บาท (${totalAmount > 0 ? (savings / totalAmount * 100).toFixed(1) : 0}%)`,
                totalAmount > 0 ? (savings / totalAmount * 100) : 0,
                '#10B981'
            );
            
            createSummaryItem(
                summarySection, 
                'สำรอง (เงินฉุกเฉิน)', 
                `${formatNumber(emergency)} บาท (${totalAmount > 0 ? (emergency / totalAmount * 100).toFixed(1) : 0}%)`,
                totalAmount > 0 ? (emergency / totalAmount * 100) : 0,
                '#F97316'
            );
        }
        
        function createSummaryItem(container, label, value, percentage, color) {
            const item = document.createElement('div');
            
            item.innerHTML = `
                <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium">${label}</span>
                    <span class="text-sm font-medium">${value}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="h-2 rounded-full" style="background-color: ${color}; width: ${percentage}%"></div>
                </div>
            `;
            
            container.appendChild(item);
        }
        
        function renderRecommendations() {
            const recommendationsList = document.getElementById('recommendationsList');
            recommendationsList.innerHTML = '';
            
            // Calculate values for recommendations
            const totalAmount = budgetCategories.reduce((sum, category) => {
                return sum + (category.adjustedMidAmount || 0) + (category.adjustedEndAmount || 0);
            }, 0);
            
            const savings = budgetCategories.filter(cat => ['savings', 'insurance'].includes(cat.id))
                .reduce((sum, cat) => {
                    return sum + (cat.adjustedMidAmount || 0) + (cat.adjustedEndAmount || 0);
                }, 0);
            
            const savingsPercentage = totalAmount > 0 ? (savings / totalAmount * 100).toFixed(1) : 0;
            
            const creditCard = budgetCategories.find(cat => cat.id === 'creditCard');
            const creditCardAmount = (creditCard?.adjustedMidAmount || 0) + (creditCard?.adjustedEndAmount || 0);
            const creditCardPercentage = totalAmount > 0 ? (creditCardAmount / totalAmount * 100).toFixed(1) : 0;
            
            const emergency = budgetCategories.find(cat => cat.id === 'emergency');
            const emergencyAmount = (emergency?.adjustedMidAmount || 0) + (emergency?.adjustedEndAmount || 0);
            
            // Add recommendations based on the data
            addRecommendation(
                recommendationsList,
                `สัดส่วนการออมอยู่ที่ ${savingsPercentage}% ${parseFloat(savingsPercentage) >= 20 ? 'ซึ่งถือว่าดี' : 'ควรพยายามเพิ่มให้ถึง 20%'} (เป้าหมายทั่วไปคือ 20%)`
            );
            
            if (parseFloat(creditCardPercentage) > 20) {
                addRecommendation(
                    recommendationsList,
                    `ควรพิจารณาลดภาระบัตรเครดิตลงหากเป็นไปได้ (ปัจจุบัน ${creditCardPercentage}% ของรายรับ)`
                );
            }
            
            const monthlyExpenses = budgetCategories.filter(cat => ['food', 'rent'].includes(cat.id))
                .reduce((sum, cat) => {
                    return sum + (cat.adjustedMidAmount || 0) + (cat.adjustedEndAmount || 0);
                }, 0);
            
            const emergencyMonths = monthlyExpenses > 0 ? emergencyAmount / monthlyExpenses : 0;
            
            addRecommendation(
                recommendationsList,
                `เงินฉุกเฉินปัจจุบันคิดเป็น ${emergencyMonths.toFixed(1)} เท่าของค่าใช้จ่ายรายเดือน (ควรสะสมให้ได้อย่างน้อย 3-6 เท่า)`
            );
            
            // Add recommendation about the two-part salary
            addRecommendation(
                recommendationsList,
                `การแบ่งรายจ่ายให้สอดคล้องกับช่วงเวลารับเงินเดือนช่วยให้บริหารเงินได้ดีขึ้น`
            );
        }
        
        function addRecommendation(container, text) {
            const item = document.createElement('li');
            item.innerHTML = `• ${text}`;
            container.appendChild(item);
        }
        
        function renderMidMonthAllocation() {
            const container = document.getElementById('midMonthAllocationCards');
            container.innerHTML = '';
            
            const actionPlan = document.getElementById('midMonthActionPlan');
            actionPlan.innerHTML = '';
            
            const midMonthSalary = parseFloat(document.getElementById('midMonthSalary').value) || 0;
            
            // Filter categories with mid-month allocation
            const midMonthCategories = budgetCategories.filter(cat => 
                (cat.adjustedMidAmount || 0) > 0
            ).sort((a, b) => a.priority - b.priority);
            
            // Create allocation cards
            midMonthCategories.forEach(category => {
                const amount = category.adjustedMidAmount || 0;
                const percentage = midMonthSalary > 0 ? (amount / midMonthSalary * 100).toFixed(1) : 0;
                
                const card = document.createElement('div');
                card.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow allocation-item';
                
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <span class="w-8 h-8 rounded-full flex items-center justify-center mr-2 text-white" style="background-color: ${category.color}">
                                ${category.icon}
                            </span>
                            <span class="font-medium">${category.name}</span>
                        </div>
                        <span class="text-lg font-semibold">฿${formatNumber(amount)}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                        <div class="h-2 rounded-full" style="background-color: ${category.color}; width: ${percentage}%"></div>
                    </div>
                    <div class="text-xs text-right text-gray-500">${percentage}% ของเงินเดือนวันที่ 15</div>
                `;
                
                container.appendChild(card);
                
                // Add to action plan
                const actionItem = document.createElement('li');
                actionItem.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm';
                
                actionItem.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-8 h-8 rounded-full flex items-center justify-center mr-3 text-white" style="background-color: ${category.color}">
                            ${category.icon}
                        </span>
                        <div>
                            <h4 class="font-medium">${category.name}: ฿${formatNumber(amount)}</h4>
                            <p class="text-sm text-gray-600 mt-1">${category.comment}</p>
                        </div>
                    </div>
                `;
                
                actionPlan.appendChild(actionItem);
            });
        }
        
        function renderEndMonthAllocation() {
            const container = document.getElementById('endMonthAllocationCards');
            container.innerHTML = '';
            
            const actionPlan = document.getElementById('endMonthActionPlan');
            actionPlan.innerHTML = '';
            
            const endMonthSalary = parseFloat(document.getElementById('endMonthSalary').value) || 0;
            
            // Filter categories with end-month allocation
            const endMonthCategories = budgetCategories.filter(cat => 
                (cat.adjustedEndAmount || 0) > 0
            ).sort((a, b) => a.priority - b.priority);
            
            // Create allocation cards
            endMonthCategories.forEach(category => {
                const amount = category.adjustedEndAmount || 0;
                const percentage = endMonthSalary > 0 ? (amount / endMonthSalary * 100).toFixed(1) : 0;
                
                const card = document.createElement('div');
                card.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow allocation-item';
                
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <span class="w-8 h-8 rounded-full flex items-center justify-center mr-2 text-white" style="background-color: ${category.color}">
                                ${category.icon}
                            </span>
                            <span class="font-medium">${category.name}</span>
                        </div>
                        <span class="text-lg font-semibold">฿${formatNumber(amount)}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                        <div class="h-2 rounded-full" style="background-color: ${category.color}; width: ${percentage}%"></div>
                    </div>
                    <div class="text-xs text-right text-gray-500">${percentage}% ของเงินเดือนสิ้นเดือน</div>
                `;
                
                container.appendChild(card);
                
                // Add to action plan
                const actionItem = document.createElement('li');
                actionItem.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm';
                
                actionItem.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-8 h-8 rounded-full flex items-center justify-center mr-3 text-white" style="background-color: ${category.color}">
                            ${category.icon}
                        </span>
                        <div>
                            <h4 class="font-medium">${category.name}: ฿${formatNumber(amount)}</h4>
                            <p class="text-sm text-gray-600 mt-1">${category.comment}</p>
                        </div>
                    </div>
                `;
                
                actionPlan.appendChild(actionItem);
            });
        }
        
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            
            const midMonthSalary = parseFloat(document.getElementById('midMonthSalary').value) || 0;
            const endMonthSalary = parseFloat(document.getElementById('endMonthSalary').value) || 0;
            
            let debugText = `Mid-Month Salary: ฿${formatNumber(midMonthSalary)}\n`;
            debugText += `End-Month Salary: ฿${formatNumber(endMonthSalary)}\n`;
            debugText += `Total Monthly Income: ฿${formatNumber(midMonthSalary + endMonthSalary)}\n\n`;
            
            debugText += "Category Allocations:\n";
            debugText += "--------------------\n";
            
            budgetCategories.forEach(cat => {
                debugText += `${cat.name} (${cat.id}):\n`;
                debugText += `  Priority: ${cat.priority}\n`;
                debugText += `  Mid-Month: ฿${formatNumber(cat.adjustedMidAmount || 0)} (Target: ฿${formatNumber(cat.midMonthAmount)})\n`;
                debugText += `  End-Month: ฿${formatNumber(cat.adjustedEndAmount || 0)} (Target: ฿${formatNumber(cat.endMonthAmount)})\n`;
                debugText += `  Total: ฿${formatNumber((cat.adjustedMidAmount || 0) + (cat.adjustedEndAmount || 0))}\n\n`;
            });
            
            // Calculate totals
            const totalMidMonth = budgetCategories.reduce((sum, cat) => sum + (cat.adjustedMidAmount || 0), 0);
            const totalEndMonth = budgetCategories.reduce((sum, cat) => sum + (cat.adjustedEndAmount || 0), 0);
            
            debugText += "Totals:\n";
            debugText += "-------\n";
            debugText += `Total Mid-Month Allocated: ฿${formatNumber(totalMidMonth)} (Available: ฿${formatNumber(midMonthSalary)})\n`;
            debugText += `Total End-Month Allocated: ฿${formatNumber(totalEndMonth)} (Available: ฿${formatNumber(endMonthSalary)})\n`;
            debugText += `Total Monthly Allocated: ฿${formatNumber(totalMidMonth + totalEndMonth)} (Available: ฿${formatNumber(midMonthSalary + endMonthSalary)})\n`;
            
            // Check for discrepancies
            const midMonthDiff = midMonthSalary - totalMidMonth;
            const endMonthDiff = endMonthSalary - totalEndMonth;
            
            if (Math.abs(midMonthDiff) > 0.01) {
                debugText += `\n⚠️ Mid-Month Discrepancy: ฿${formatNumber(midMonthDiff)}\n`;
            }
            
            if (Math.abs(endMonthDiff) > 0.01) {
                debugText += `\n⚠️ End-Month Discrepancy: ฿${formatNumber(endMonthDiff)}\n`;
            }
            
            debugInfo.textContent = debugText;
        }
        
        // Helper function to format numbers with commas
        function formatNumber(num) {
            return new Intl.NumberFormat('th-TH').format(Math.round(num));
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9550e3a711cd7323',t:'MTc1MDgxNzAxNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
